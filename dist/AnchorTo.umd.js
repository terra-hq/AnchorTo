(function(f,g){typeof exports=="object"&&typeof module<"u"?module.exports=g():typeof define=="function"&&define.amd?define(g):(f=typeof globalThis<"u"?globalThis:f||self,f.AnchorTo=g())})(this,function(){"use strict";class f{constructor({trigger:t,destination:e,destinationSelector:i="",offset:o=0,url:a="hash",speed:h=1500,emitEvents:n=!0,popstate:s=!0,debug:l=!1,onComplete:c=null,beforeScroll:u=null,heightModifyingLibraries:r=[],Manager:d=null,microAdjust:m=!0,microAdjustThreshold:p=6,microAdjustDuration:w=150,disableCssSmoothDuringScroll:S=!0,postSettleAdjust:M=!0,postSettleMaxWait:y=1e3,postSettleQuietWindow:D=150,postSettleInitialDelay:v=250}){this.DOM={trigger:t,destination:e},this.offset=typeof o=="function"?o:()=>o,this.url=a,this.speed=h,this.emitEvents=n,this.popstate=s,this.debug=l,this.onComplete=c,this.beforeScroll=u,this.destinationSelector=i,this.heightModifyingLibraries=r,this.Manager=d,this.microAdjust=m,this.microAdjustThreshold=p,this.microAdjustDuration=w,this.disableCssSmoothDuringScroll=S,this.postSettleAdjust=M,this.postSettleMaxWait=y,this.postSettleQuietWindow=D,this.postSettleInitialDelay=v,this.init(),this.events(),this.debug&&console.log("AnchorTo Initialized:",{trigger:this.DOM.trigger,destination:this.DOM.destination,offset:this.offset(this.DOM.destination,this.DOM.trigger),url:this.url,speed:this.speed,emitEvents:this.emitEvents,popstate:this.popstate,microAdjust:this.microAdjust,disableCssSmoothDuringScroll:this.disableCssSmoothDuringScroll,postSettleAdjust:this.postSettleAdjust})}init(){}events(){this.DOM.trigger&&(this.DOM.trigger.tagName==="SELECT"?this.DOM.trigger.addEventListener("change",t=>this.handleSelectChange(t)):this.DOM.trigger.addEventListener("click",t=>this.handleClick(t))),this.popstate&&window.addEventListener("popstate",t=>this.handlePopstate(t))}async handleScroll(){var t;if(typeof this.beforeScroll=="function"&&await this.beforeScroll(),await this.waitForHeightModifyingLibraries(),this.destinationSelector&&(this.DOM.destination=document.getElementById(this.destinationSelector)),this.emitEvents&&this.emitEvent("AnchorToStart"),this.scrollTo(this.DOM.destination),this.url!=="none"){const e=((t=this.DOM.destination)==null?void 0:t.id)||"section";if(this.url==="hash")history.pushState(null,null,`#${e}`);else if(this.url==="query"){const i=new URLSearchParams(window.location.search);i.set("scrollto",e),history.pushState(null,null,`${window.location.pathname}?${i}`)}}}async handleClick(t){t.preventDefault(),this.handleScroll()}async handleSelectChange(t){const e=t.target.value;this.destinationSelector=e,this.DOM.destination=document.getElementById(this.destinationSelector),this.handleScroll()}handlePopstate(){const t=this.url==="query"?new URLSearchParams(window.location.search).get("scrollto"):window.location.hash.substring(1),e=document.getElementById(t);e&&this.scrollTo(e)}scrollTo(t){if(!t)return;const e=window.pageYOffset,i=t.getBoundingClientRect().top+window.pageYOffset-this.offset(t,this.DOM.trigger),o=i-e,a=this.speed;let h=null;const n=this.disableCssSmoothDuringScroll?this._temporarilyDisableCssSmoothScroll():()=>{},s=l=>{h||(h=l);const c=l-h,u=this.ease(c,e,o,a);if(window.scrollTo(0,u),c<a)requestAnimationFrame(s);else{if(window.scrollTo(0,i),this.microAdjust){const r=window.pageYOffset,d=i-r;Math.abs(d)>this.microAdjustThreshold&&this._smoothMicroAdjust(i,this.microAdjustDuration)}this.emitEvents&&this.emitEvent("AnchorToEnd"),n(),typeof this.onComplete=="function"&&this.onComplete(),this.postSettleAdjust&&this.destinationSelector&&this._postScrollSettleAdjust()}};requestAnimationFrame(s)}_postScrollSettleAdjust(){const t=performance.now();let e=t,i,o;const a=()=>{const s=document.getElementById(this.destinationSelector);if(!s)return;const l=window.pageYOffset+s.getBoundingClientRect().top-this.offset(s,this.DOM.trigger),c=l-window.pageYOffset;Math.abs(c)>this.microAdjustThreshold&&this._smoothMicroAdjust(l,this.microAdjustDuration)},h=()=>{i&&i.disconnect(),o&&clearTimeout(o)},n=()=>{const s=performance.now(),l=s-t>=this.postSettleMaxWait,c=s-e>=this.postSettleQuietWindow;l||c?(h(),a()):o=setTimeout(n,this.postSettleQuietWindow/2)};setTimeout(()=>{if("ResizeObserver"in window)i=new ResizeObserver(()=>{e=performance.now()}),i.observe(document.body);else{const s=()=>{e=performance.now(),performance.now()-t<this.postSettleMaxWait&&setTimeout(s,100)};s()}n()},this.postSettleInitialDelay)}waitForHeightModifyingLibraries(){return new Promise(t=>{if(this.heightModifyingLibraries.length===0||!this.Manager){t();return}let e=0;const i=20,o=()=>{e++;const a=this.heightModifyingLibraries.filter(n=>this.Manager.libraries[n]);if(a.length===0){t();return}a.every(n=>this.Manager.instances[n]&&this.Manager.instances[n].length>0)||e>=i?t():setTimeout(o,50)};setTimeout(o,100)})}ease(t,e,i,o){return t/=o/2,t<1?i/2*t*t+e:(t--,-i/2*(t*(t-2)-1)+e)}emitEvent(t){const e=new CustomEvent(t,{detail:{element:this.DOM.trigger}});this.DOM.trigger.dispatchEvent(e)}_smoothMicroAdjust(t,e=150){const i=document.documentElement,o=document.body,a=Math.max(0,(i.scrollHeight||o.scrollHeight)-window.innerHeight),h=window.pageYOffset,n=Math.min(a,Math.max(0,t)),s=n-h;if(Math.abs(s)<1)return;let l=null;const c=(r,d,m,p)=>(r/=p/2,r<1?m/2*r*r+d:(r--,-m/2*(r*(r-2)-1)+d)),u=r=>{l==null&&(l=r);const d=r-l,m=c(d,h,s,e);window.scrollTo(0,m),d<e?requestAnimationFrame(u):window.scrollTo(0,n)};requestAnimationFrame(u)}_temporarilyDisableCssSmoothScroll(){const t=document.documentElement,e=t.style.scrollBehavior;return t.style.scrollBehavior="auto",()=>{t.style.scrollBehavior=e||""}}destroy(){this.DOM.trigger&&this.DOM.trigger.removeEventListener("click",t=>this.handleClick(t)),this.popstate&&window.removeEventListener("popstate",t=>this.handlePopstate(t))}}return f});
